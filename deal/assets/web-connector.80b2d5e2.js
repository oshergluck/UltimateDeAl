import{ec as w,ed as c,ee as f,dV as y,d$ as L,ef as b,eg as I}from"./index.a890a1de.js";import{I as v,L as g,r as O,l as E}from"./passkeys.567f9269.js";async function W(u,e){return await u({method:"eth_sendRawTransaction",params:[e]})}function h(u){return new Promise(e=>{setTimeout(e,u*1e3)})}const T={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},p=new Map;class A{constructor({link:e,baseUrl:t,iframeId:i,container:r=document.body,onIframeInitialize:a}){Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.iframeBaseUrl=t;let n=document.getElementById(i);const s=new URL(e);if(!n||n.src!==s.href){if(!n){n=document.createElement("iframe");const o={...T};Object.assign(n.style,o),n.setAttribute("id",i),n.setAttribute("fetchpriority","high"),r.appendChild(n)}n.src=s.href;const l=o=>{if(o.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",l),!n){console.warn("thirdweb Iframe not found");return}this.onIframeLoadHandler(n,a)()}};window.addEventListener("message",l)}this.iframe=n}async onIframeLoadedInitVariables(){return{}}onIframeLoadHandler(e,t){return async()=>{const i=new MessageChannel,r=new Promise((n,s)=>{i.port1.onmessage=l=>{const{data:o}=l;i.port1.close(),o.success||s(new Error(o.error)),p.set(e.src,!0),t&&t(),n(!0)}}),a="initIframe";e?.contentWindow?.postMessage({eventType:a,data:await this.onIframeLoadedInitVariables()},this.iframeBaseUrl,[i.port2]),await r}}async call({procedureName:e,params:t,showIframe:i=!1}){for(;!p.get(this.iframe.src);)await h(this.POLLING_INTERVAL_SECONDS);i&&(this.iframe.style.display="block",await h(.005));const r=new MessageChannel,a=new Promise((n,s)=>{r.port1.onmessage=async l=>{const{data:o}=l;r.port1.close(),i&&(await h(.1),this.iframe.style.display="none"),o.success?n(o.data):s(new Error(o.error))}});return this.iframe.contentWindow?.postMessage({eventType:e,data:t},this.iframeBaseUrl,[r.port2]),a}destroy(){p.delete(this.iframe.src)}}class S extends A{constructor({clientId:e,baseUrl:t}){super({iframeId:N,link:P({clientId:e,path:v,baseUrl:t}).href,baseUrl:t,container:document.body}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.clientId=e}async onIframeLoadedInitVariables(){const e=new g({clientId:this.clientId});return{authCookie:await e.getAuthCookie(),deviceShareStored:await e.getDeviceShare(),walletUserId:await e.getWalletUserId(),clientId:this.clientId}}}function P({clientId:u,baseUrl:e,path:t,queryParams:i}){const r=new URL(`${t}`,e);if(i)for(const a of Object.keys(i))r.searchParams.set(a,i[a]?.toString()||"");return r.searchParams.set("clientId",u),r}const N="thirdweb-in-app-wallet-iframe";class C{constructor({baseUrl:e,querier:t,preLogin:i,postLogin:r,client:a}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=t,this.preLogin=i,this.postLogin=r,this.client=a}async sendEmailLoginOtp({email:e}){return await this.preLogin(),await this.LoginQuerier.call({procedureName:"sendThirdwebEmailLoginOtp",params:{email:e}})}async sendSmsLoginOtp({phoneNumber:e}){return await this.preLogin(),await this.LoginQuerier.call({procedureName:"sendThirdwebSmsLoginOtp",params:{phoneNumber:e}})}}class _ extends C{constructor(){super(...arguments),Object.defineProperty(this,"closeWindow",{enumerable:!0,configurable:!0,writable:!0,value:({isWindowOpenedByFn:e,win:t,closeOpenedWindow:i})=>{e?t?.close():t&&i?i(t):t&&t.close()}})}async getOauthLoginUrl(e){return await this.LoginQuerier.call({procedureName:"getHeadlessOauthLoginLink",params:{authProvider:e}})}async loginWithModal(){await this.preLogin();const e=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:void 0,showIframe:!0});return this.postLogin(e)}async loginWithEmailOtp({email:e}){await this.preLogin();const t=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:{email:e},showIframe:!0});return this.postLogin(t)}getOauthPopUpSizing(e){switch(e){case w.FACEBOOK:return"width=715, height=555";default:return"width=350, height=500"}}async loginWithOauth(e){let t=e?.openedWindow,i=!1;if(t||(t=window.open("","Login",this.getOauthPopUpSizing(e.oauthProvider)),i=!0),!t)throw new Error("Something went wrong opening pop-up");const[{loginLink:r}]=await Promise.all([this.getOauthLoginUrl(e.oauthProvider),this.preLogin()]);t.location.href=r;const a=await new Promise((n,s)=>{const l=window.setInterval(async()=>{!t||t.closed&&(clearInterval(l),window.removeEventListener("message",o),s(new Error("User closed login window")))},1e3),o=async d=>{if(d.origin===this.baseUrl){if(typeof d.data!="object"){s(new Error("Invalid event data"));return}switch(d.data.eventType){case"userLoginSuccess":{window.removeEventListener("message",o),clearInterval(l),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),d.data.authResult&&n(d.data.authResult);break}case"userLoginFailed":{window.removeEventListener("message",o),clearInterval(l),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),s(new Error(d.data.error));break}case"injectDeveloperClientId":{t?.postMessage({eventType:"injectDeveloperClientIdResult",developerClientId:this.client.clientId,authOption:e.oauthProvider},this.baseUrl);break}}}};window.addEventListener("message",o)});return this.postLogin({storedToken:{...a.storedToken,shouldStoreCookieString:!0},walletDetails:{...a.walletDetails,isIframeStorageEnabled:!1}})}async loginWithCustomJwt({encryptionKey:e,jwt:t}){await this.preLogin();const i=await this.LoginQuerier.call({procedureName:"loginWithCustomJwt",params:{encryptionKey:e,jwt:t}});return this.postLogin(i)}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:t}){await this.preLogin();const i=await this.LoginQuerier.call({procedureName:"loginWithCustomAuthEndpoint",params:{encryptionKey:e,payload:t}});return this.postLogin(i)}async verifyEmailLoginOtp({email:e,otp:t,recoveryCode:i}){const r=await this.LoginQuerier.call({procedureName:"verifyThirdwebEmailLoginOtp",params:{email:e,otp:t,recoveryCode:i}});return this.postLogin(r)}async verifySmsLoginOtp({phoneNumber:e,otp:t,recoveryCode:i}){const r=await this.LoginQuerier.call({procedureName:"verifyThirdwebSmsLoginOtp",params:{phoneNumber:e,otp:t,recoveryCode:i}});return this.postLogin(r)}}class D{constructor({client:e,querier:t,onAuthSuccess:i,baseUrl:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.AuthQuerier=t,this.localStorage=new g({clientId:e.clientId}),this.onAuthSuccess=i,this.BaseLogin=new _({postLogin:async a=>this.postLogin(a),preLogin:async()=>{await this.preLogin()},querier:t,client:e,baseUrl:r})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString),await this.onAuthSuccess({storedToken:e,walletDetails:t})}async loginWithAuthToken(e,t){await this.preLogin();const i=await this.AuthQuerier.call({procedureName:"loginWithStoredTokenDetails",params:{storedToken:e.storedToken,recoveryCode:t}});return this.postLogin(i)}async loginWithModal(){return this.BaseLogin.loginWithModal()}async loginWithEmailOtp(e){return this.BaseLogin.loginWithEmailOtp(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async loginWithOauth(e){return this.BaseLogin.loginWithOauth(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async sendSmsLoginOtp({phoneNumber:e}){return this.BaseLogin.sendSmsLoginOtp({phoneNumber:e})}async verifyEmailLoginOtp(e){return this.BaseLogin.verifyEmailLoginOtp(e)}async verifySmsLoginOtp(e){return this.BaseLogin.verifySmsLoginOtp(e)}async logout(){const{success:e}=await this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=await this.localStorage.removeAuthCookie(),i=await this.localStorage.removeWalletUserId();return{success:e||t||i}}}class k{constructor({client:e,querier:t}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.walletManagerQuerier=t,this.localStorage=new g({clientId:e.clientId})}async postWalletSetUp({deviceShareStored:e,walletAddress:t,isIframeStorageEnabled:i,walletUserId:r}){return i||await this.localStorage.saveDeviceShare(e,r),{walletAddress:t}}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status===c.LOGGED_IN_WALLET_INITIALIZED?{status:c.LOGGED_IN_WALLET_INITIALIZED,...e.user,account:await this.getAccount()}:e.status===c.LOGGED_IN_NEW_DEVICE?{status:c.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:e.status===c.LOGGED_IN_WALLET_UNINITIALIZED?{status:c.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:{status:e.status}}async getAccount(){const e=this.walletManagerQuerier,{address:t}=await e.call({procedureName:"getAddress",params:void 0}),i=async a=>{const n={to:a.to??void 0,data:a.data,value:a.value,gasLimit:a.gas,nonce:a.nonce,chainId:a.chainId};a.maxFeePerGas?(n.accessList=a.accessList,n.maxFeePerGas=a.maxFeePerGas,n.maxPriorityFeePerGas=a.maxPriorityFeePerGas,n.type=2):(n.gasPrice=a.gasPrice,n.type=0);const{signedTransaction:s}=await e.call({procedureName:"signTransaction",params:{transaction:n,chainId:a.chainId,rpcEndpoint:`https://${a.chainId}.rpc.thirdweb.com`}});return s},r=this.client;return{address:t,async signTransaction(a){if(!a.chainId)throw new Error("chainId required in tx to sign");return i({...a,chainId:a.chainId})},async sendTransaction(a){const n=f({client:r,chain:y(a.chainId)}),s=await i(a);return{transactionHash:await W(n,s)}},async signMessage({message:a}){const n=typeof a=="string"?a:a.raw,{signedMessage:s}=await e.call({procedureName:"signMessage",params:{message:n,chainId:1}});return s},async signTypedData(a){const n=L(a);n.types?.EIP712Domain&&(n.types.EIP712Domain=void 0);const s=n.domain,l=s?.chainId||1,{signedTypedData:o}=await e.call({procedureName:"signTypedDataV4",params:{domain:{chainId:l,verifyingContract:s?.verifyingContract,name:s?.name,version:s?.version},types:n.types,message:n.message,chainId:l,rpcEndpoint:`https://${l}.rpc.thirdweb.com`}});return o}}}}class B{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor({client:e,onAuthSuccess:t}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const i=b("inAppWallet");this.client=e,this.querier=new S({clientId:e.clientId,baseUrl:i}),this.wallet=new k({client:e,querier:this.querier}),this.auth=new D({client:e,querier:this.querier,baseUrl:i,onAuthSuccess:async r=>(t?.(r),await this.wallet.postWalletSetUp({...r.walletDetails,walletUserId:r.storedToken.authDetails.userWalletId}),await this.querier.call({procedureName:"initIframe",params:{deviceShareStored:r.walletDetails.deviceShareStored,clientId:this.client.clientId,walletUserId:r.storedToken.authDetails.userWalletId,authCookie:r.storedToken.cookieString}}),{user:{status:c.LOGGED_IN_WALLET_INITIALIZED,authDetails:r.storedToken.authDetails,account:await this.wallet.getAccount(),walletAddress:r.walletDetails.walletAddress}})})}async getUser(){return this.wallet.getUserWalletStatus()}getAccount(){return this.wallet.getAccount()}async preAuthenticate(e){const t=e.strategy;switch(t){case"email":return this.auth.sendEmailLoginOtp({email:e.email});case"phone":return this.auth.sendSmsLoginOtp({phoneNumber:e.phoneNumber});default:m(t,`Provider: ${t} doesnt require pre-authentication`)}}async authenticate(e){const t=e.strategy;switch(t){case"email":return await this.auth.verifyEmailLoginOtp({email:e.email,otp:e.verificationCode});case"phone":return await this.auth.verifySmsLoginOtp({otp:e.verificationCode,phoneNumber:e.phoneNumber});case"apple":case"facebook":case"google":{const i=I[t];return this.auth.loginWithOauth({oauthProvider:i,closeOpenedWindow:e.closeOpenedWindow,openedWindow:e.openedWindow})}case"jwt":return this.auth.loginWithCustomJwt({jwt:e.jwt,encryptionKey:e.encryptionKey});case"auth_endpoint":return this.auth.loginWithCustomAuthEndpoint({payload:e.payload,encryptionKey:e.encryptionKey});case"iframe_email_verification":return this.auth.loginWithEmailOtp({email:e.email});case"iframe":return this.auth.loginWithModal();case"passkey":{if(e.type==="sign-up"){const r=await O({client:e.client,authenticatorType:e.authenticatorType,username:e.passkeyName});return this.auth.loginWithAuthToken(r)}const i=await E({client:e.client,authenticatorType:e.authenticatorType});return this.auth.loginWithAuthToken(i)}default:m(t)}}async logout(){return await this.auth.logout()}}function m(u,e){throw new Error(e??`Invalid param: ${u}`)}export{B as InAppWebConnector};
